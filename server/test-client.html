<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Test Client</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
    input, button { padding: 10px; margin: 5px; }
    #messages { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; margin: 10px 0; }
    .message { margin: 5px 0; padding: 5px; background: #f0f0f0; border-radius: 5px; }
    .sent { background: #d4edda; }
    .received { background: #d1ecf1; }
  </style>
</head>
<body>
  <h1>WebSocket Test Client</h1>
  
  <div>
    <h3>1. Login First</h3>
    <input type="text" id="username" placeholder="Username" value="vibhu2">
    <input type="password" id="password" placeholder="Password" value="user123">
    <button onclick="login()">Login</button>
    <div id="loginStatus"></div>
  </div>
  
  <div id="chatSection" style="display:none;">
    <h3>2. Send Message</h3>
    <input type="number" id="receiverId" placeholder="Receiver User ID" value="1">
    <input type="text" id="messageContent" placeholder="Message" value="Hello!">
    <button onclick="sendMessage()">Send Message</button>
    
    <h3>Messages</h3>
    <div id="messages"></div>
  </div>
  
  <script>
    let socket;
    let token;
    let currentUser;
    
    async function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      console.log('Attempting login with:', { username, password }); // Debug
      try {
        const response = await fetch('http://localhost:3000/api/auth/login', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ username, password })
    });
    
    console.log('Response status:', response.status); // Debug
        
        const data = await response.json();
          console.log('Response data:', data); // Debug
    if (response.ok) {
      token = data.token;
      currentUser = data.user;
      document.getElementById('loginStatus').innerHTML = 
        `✅ Logged in as ${data.user.username} (ID: ${data.user.id})`;
      document.getElementById('chatSection').style.display = 'block';
      connectWebSocket();
    } else {
      document.getElementById('loginStatus').innerHTML = `❌ ${data.error}`;
    }
  } catch (err) {
    console.error('Login error:', err); // Debug
    document.getElementById('loginStatus').innerHTML = `❌ Error: ${err.message}`;
  }
    }
    
    function connectWebSocket() {
      socket = io('http://localhost:3000', {
        auth: { token }
      });
      
      socket.on('connect', () => {
        addMessage('System', '✅ Connected to server');
      });
      
      socket.on('message:receive', (data) => {
        addMessage(`${data.senderUsername}`, data.content, 'received');
      });
      
      socket.on('message:sent', (data) => {
        addMessage('You', 'Message sent successfully', 'sent');
      });
      
      socket.on('user:online', (data) => {
        addMessage('System', `${data.username} is now online`);
      });
      
      socket.on('user:offline', (data) => {
        addMessage('System', `${data.username} is now offline`);
      });
      
      socket.on('disconnect', () => {
        addMessage('System', '❌ Disconnected from server');
      });
    }
    
    function sendMessage() {
      const receiverId = parseInt(document.getElementById('receiverId').value);
      const content = document.getElementById('messageContent').value;
      
      socket.emit('message:send', {
        receiverId,
        content,
        tempId: Date.now()
      });
      
      document.getElementById('messageContent').value = '';
    }
    
    function addMessage(sender, content, type = '') {
      const messagesDiv = document.getElementById('messages');
      const messageEl = document.createElement('div');
      messageEl.className = `message ${type}`;
      messageEl.innerHTML = `<strong>${sender}:</strong> ${content}`;
      messagesDiv.appendChild(messageEl);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
  </script>
</body>
</html>